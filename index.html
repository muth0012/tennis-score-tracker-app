<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Rigid 5-Column Grid System for guaranteed alignment */
        .score-grid {
            display: grid;
            grid-template-columns: 2.5fr 0.8fr 0.8fr 0.8fr 2fr;
            align-items: center;
            text-align: center;
        }

        .custom-shadow { box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1); }
        .modal-overlay { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); }
        
        /* Hidden but occupying space to maintain grid alignment */
        .invisible-col { opacity: 0; pointer-events: none; }
    </style>

    <!-- Firebase v8 SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-12">

    <div id="app-container" class="max-w-lg mx-auto px-4 pt-6">
        <!-- Persistent Header -->
        <header class="bg-white rounded-3xl p-6 mb-6 border border-slate-200 custom-shadow">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-2xl font-black text-indigo-600 tracking-tighter">Tennis Tracker</h1>
                <div id="timer-display" class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-[10px] font-black font-mono">00:00:00</div>
            </div>
            <div class="flex justify-between text-[9px] text-slate-400 font-bold uppercase tracking-widest border-t border-slate-50 pt-3">
                <span id="meta-id">Match: ---</span>
                <span id="meta-loc">Loc: ---</span>
            </div>
        </header>

        <!-- Scoreboard (Fixed Grid) -->
        <section id="scoreboard" class="bg-white rounded-3xl overflow-hidden mb-6 border border-slate-200 shadow-xl hidden">
            <div class="score-grid bg-slate-800 text-white text-[9px] font-black uppercase tracking-widest p-3">
                <div class="text-left pl-3">Competitor</div>
                <div data-col="1">S1</div>
                <div data-col="2">S2</div>
                <div data-col="3">S3</div>
                <div>Game</div>
            </div>
            <!-- Player 1 Row -->
            <div class="score-grid border-b border-slate-50 py-5 px-2 items-center">
                <div class="text-left pl-3 font-bold text-slate-700 flex items-center truncate">
                    <span id="ui-p1-name">P1</span>
                    <span id="ui-p1-srv" class="ml-2"></span>
                </div>
                <div id="ui-p1-s1" class="font-mono text-slate-400 font-bold text-lg">0</div>
                <div id="ui-p1-s2" data-col="2" class="font-mono text-slate-400 font-bold text-lg">0</div>
                <div id="ui-p1-s3" data-col="3" class="font-mono text-slate-400 font-bold text-lg">0</div>
                <div id="ui-p1-game" class="font-black text-indigo-600 text-2xl">0</div>
            </div>
            <!-- Player 2 Row -->
            <div class="score-grid py-5 px-2 items-center">
                <div class="text-left pl-3 font-bold text-slate-700 flex items-center truncate">
                    <span id="ui-p2-name">P2</span>
                    <span id="ui-p2-srv" class="ml-2"></span>
                </div>
                <div id="ui-p2-s1" class="font-mono text-slate-400 font-bold text-lg">0</div>
                <div id="ui-p2-s2" data-col="2" class="font-mono text-slate-400 font-bold text-lg">0</div>
                <div id="ui-p2-s3" data-col="3" class="font-mono text-slate-400 font-bold text-lg">0</div>
                <div id="ui-p2-game" class="font-black text-indigo-600 text-2xl">0</div>
            </div>
        </section>

        <!-- Main Scoring Interface -->
        <section id="controls" class="space-y-6 hidden">
            <div id="match-status-banner" class="text-center py-2 bg-slate-100 text-slate-500 rounded-2xl text-[10px] font-black uppercase tracking-widest mb-4">
                Set 1 in Progress
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="recordPoint(1)" class="bg-indigo-600 text-white p-7 rounded-[2rem] shadow-lg shadow-indigo-100 active:scale-95 transition-transform">
                    <span class="block text-[10px] font-black opacity-50 uppercase mb-1">Point For</span>
                    <span id="btn-p1-label" class="block font-bold truncate text-xl">Player 1</span>
                </button>
                <button onclick="recordPoint(2)" class="bg-indigo-600 text-white p-7 rounded-[2rem] shadow-lg shadow-indigo-100 active:scale-95 transition-transform">
                    <span class="block text-[10px] font-black opacity-50 uppercase mb-1">Point For</span>
                    <span id="btn-p2-label" class="block font-bold truncate text-xl">Player 2</span>
                </button>
            </div>

            <!-- Point Data Entry -->
            <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm grid grid-cols-3 gap-4">
                <div>
                    <label class="text-[9px] font-black text-slate-400 uppercase block mb-1">1st Serve</label>
                    <select id="in-serve" class="w-full bg-slate-50 border-none rounded-xl p-2 text-xs font-bold focus:ring-2 focus:ring-indigo-500 appearance-none">
                        <option value="IN">In</option>
                        <option value="FAULT">Fault</option>
                        <option value="ACE">Ace</option>
                    </select>
                </div>
                <div>
                    <label class="text-[9px] font-black text-slate-400 uppercase block mb-1">Rally</label>
                    <input type="number" id="in-rally" value="1" min="1" class="w-full bg-slate-50 border-none rounded-xl p-2 text-xs font-bold">
                </div>
                <div>
                    <label class="text-[9px] font-black text-slate-400 uppercase block mb-1">Type</label>
                    <select id="in-type" class="w-full bg-slate-50 border-none rounded-xl p-2 text-xs font-bold focus:ring-2 focus:ring-indigo-500 appearance-none">
                        <option value="W-G">Winner</option>
                        <option value="UE">Error (UE)</option>
                        <option value="ACE">Ace</option>
                        <option value="DF">D-Fault</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-3">
                <button onclick="undo()" class="bg-white border py-3 rounded-2xl text-[10px] font-black uppercase text-slate-400 shadow-sm">Undo</button>
                <button onclick="toggleModal('history')" class="bg-white border py-3 rounded-2xl text-[10px] font-black uppercase text-slate-400 shadow-sm">History</button>
                <button onclick="toggleModal('stats')" class="bg-white border py-3 rounded-2xl text-[10px] font-black uppercase text-slate-400 shadow-sm">Stats</button>
            </div>
        </section>

        <!-- Spectator View Message -->
        <div id="spectator-msg" class="hidden text-center p-10 bg-white rounded-[2.5rem] border border-slate-200 shadow-xl mt-6">
            <div class="flex flex-col items-center">
                <div class="w-3 h-3 bg-indigo-600 rounded-full animate-ping mb-4"></div>
                <p class="text-indigo-600 font-black uppercase tracking-tighter text-sm">Live Scoreboard View Only</p>
                <p class="text-slate-400 text-[10px] mt-2 font-medium">Scores update automatically in real-time</p>
            </div>
        </div>

        <!-- Sticky Footer Buttons -->
        <footer class="mt-12 space-y-3">
            <button id="btn-share" onclick="copyShareLink()" class="hidden w-full py-4 bg-emerald-500 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">Copy Live Spectator Link</button>
            <button onclick="exportCSV()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold active:scale-95 transition-transform">Download Match CSV</button>
            <button onclick="resetMatch()" class="w-full py-4 text-rose-500 font-bold text-sm bg-white border border-rose-100 rounded-2xl">Start New Match / Reset</button>
        </footer>
    </div>

    <!-- MODAL: SETUP -->
    <div id="modal-setup" class="fixed inset-0 modal-overlay flex items-center justify-center p-6 z-[100]">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl">
            <h2 class="text-3xl font-black text-slate-800 mb-8 tracking-tighter">Match Setup</h2>
            
            <div class="space-y-4">
                <div class="space-y-2">
                    <input type="text" id="setup-p1" placeholder="Player 1" class="w-full bg-slate-100 border-none p-4 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition-all placeholder:text-slate-300">
                    <input type="text" id="setup-p2" placeholder="Player 2" class="w-full bg-slate-100 border-none p-4 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition-all placeholder:text-slate-300">
                    <input type="text" id="setup-loc" placeholder="Location (e.g. Center Court)" class="w-full bg-slate-100 border-none p-4 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition-all placeholder:text-slate-300">
                </div>

                <div class="pt-4">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-3 mb-2 block">Match Format</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="fmt" value="pro-ad" checked class="peer sr-only">
                            <div class="peer-checked:bg-indigo-600 peer-checked:text-white bg-slate-100 text-slate-400 py-4 rounded-2xl text-[10px] font-black text-center uppercase tracking-widest transition-all">8G Pro (Ad)</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="fmt" value="b3-ad" class="peer sr-only">
                            <div class="peer-checked:bg-indigo-600 peer-checked:text-white bg-slate-100 text-slate-400 py-4 rounded-2xl text-[10px] font-black text-center uppercase tracking-widest transition-all">Best of 3</div>
                        </label>
                    </div>
                </div>

                <div class="flex justify-between items-center bg-slate-50 p-4 rounded-3xl border border-slate-100 mt-4">
                    <span class="text-[10px] font-black text-slate-400 uppercase ml-2">Who Serves?</span>
                    <div class="flex space-x-2">
                        <label class="cursor-pointer"><input type="radio" name="srv" value="1" checked class="peer sr-only"><div class="peer-checked:bg-indigo-600 peer-checked:text-white w-10 h-10 flex items-center justify-center bg-white rounded-xl text-xs font-bold transition-all shadow-sm">P1</div></label>
                        <label class="cursor-pointer"><input type="radio" name="srv" value="2" class="peer sr-only"><div class="peer-checked:bg-indigo-600 peer-checked:text-white w-10 h-10 flex items-center justify-center bg-white rounded-xl text-xs font-bold transition-all shadow-sm">P2</div></label>
                    </div>
                </div>

                <button id="start-btn" onclick="startMatch()" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-bold shadow-2xl shadow-indigo-100 mt-6 active:scale-95 transition-all text-lg">Start Match</button>
            </div>
        </div>
    </div>

    <!-- MODAL: DATA DISPLAY -->
    <div id="modal-data" class="fixed inset-0 modal-overlay hidden items-center justify-center p-6 z-[110]">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-black">Archive</h2>
                <button onclick="closeModals()" class="bg-slate-100 w-10 h-10 rounded-full flex items-center justify-center text-slate-400 hover:text-slate-900 transition-colors">‚úï</button>
            </div>
            <div id="modal-content" class="overflow-y-auto space-y-4 pr-2"></div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let liveDurationInterval = null;
        let db, auth, appId;
        const scoreStrings = { 0: '0', 1: '15', 2: '30', 3: '40', 4: 'Ad' };

        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBOdTC5Q8MmbDhlNGlpm-EFQgJFZebIUZI",
            authDomain: "tennis-score-tracker-bd317.firebaseapp.com",
            projectId: "tennis-score-tracker-bd317",
            storageBucket: "tennis-score-tracker-bd317.firebasestorage.app",
            messagingSenderId: "301275539476",
            appId: "1:301275539476:web:6ae1032d7d23f7c699df01"
        };

        // Internal State
        let matchState = {
            id: "", status: "SETUP", p1: "Player 1", p2: "Player 2", loc: "Court", fmt: "pro-ad",
            srv: 1, set: 0, setsWon: [0,0], games: [[0,0],[0,0],[0,0]], score: [0,0],
            history: [], start: null, end: null, tie: false
        };

        // --- CORE SCORING ENGINE ---
        function getRules() {
            const isPro = matchState.fmt.startsWith('pro');
            return {
                isPro: isPro,
                winGames: isPro ? 8 : 6,
                targetSets: isPro ? 1 : 2
            };
        }

        window.recordPoint = function(winner) {
            if (matchState.status !== 'PLAYING') return;

            const idx = winner - 1;
            const opp = idx === 0 ? 1 : 0;
            
            const entry = {
                w: winner === 1 ? matchState.p1 : matchState.p2,
                t: document.getElementById('in-type').value,
                s: document.getElementById('in-serve').value,
                r: document.getElementById('in-rally').value,
                time: Date.now()
            };

            if (matchState.tie) {
                // Tiebreak Scoring (First to 7, win by 2)
                matchState.score[idx]++;
                if (matchState.score[idx] >= 7 && (matchState.score[idx] - matchState.score[opp] >= 2)) {
                    processGameWin(winner);
                }
            } else {
                // ADVANTAGE SCORING LOGIC
                if (matchState.score[idx] === 3 && matchState.score[opp] < 3) {
                    processGameWin(winner); // Winning from 40-0, 40-15, 40-30
                } else if (matchState.score[idx] === 3 && matchState.score[opp] === 3) {
                    matchState.score[idx] = 4; // Deuce -> Ad
                } else if (matchState.score[idx] === 4) {
                    processGameWin(winner); // Ad -> WIN
                } else if (matchState.score[opp] === 4) {
                    matchState.score[opp] = 3; // Opp Ad -> Return to Deuce
                } else {
                    matchState.score[idx]++; // Normal progression
                }
            }

            matchState.history.push(entry);
            syncState();
        }

        function processGameWin(winner) {
            const setNum = matchState.set;
            matchState.games[setNum][winner - 1]++;
            matchState.score = [0, 0];
            matchState.tie = false;
            matchState.srv = (matchState.srv === 1) ? 2 : 1; // Service Switch

            const rules = getRules();
            const g1 = matchState.games[setNum][0];
            const g2 = matchState.games[setNum][1];

            // Win set?
            if ((g1 >= rules.winGames || g2 >= rules.winGames) && Math.abs(g1 - g2) >= 2) {
                processSetWin(winner);
            } else if (g1 === rules.winGames && g2 === rules.winGames) {
                matchState.tie = true;
            }
        }

        function processSetWin(winner) {
            matchState.setsWon[winner - 1]++;
            const rules = getRules();
            if (matchState.setsWon[winner - 1] === rules.targetSets) {
                matchState.status = "ENDED";
                matchState.end = Date.now();
            } else {
                matchState.set++;
            }
        }

        // --- DATABASE & SYNC ---
        async function syncState() {
            if (!matchState.id || !db) return;
            const data = JSON.parse(JSON.stringify(matchState));
            // Firestore nesting guard
            data.games = JSON.stringify(data.games);
            const path = `artifacts/${appId}/public/data/matches`;
            await db.collection(path).doc(matchState.id).set(data);
            renderUI();
        }

        function renderUI() {
            const urlParams = new URLSearchParams(window.location.search);
            const isSpectator = urlParams.get('mode') === 'spectate';
            const isSetup = matchState.status === "SETUP";

            // Modals & Panels Visibility
            document.getElementById('modal-setup').style.display = (isSetup && !isSpectator) ? 'flex' : 'none';
            document.getElementById('scoreboard').classList.toggle('hidden', isSetup);
            document.getElementById('controls').classList.toggle('hidden', isSetup || isSpectator);
            document.getElementById('spectator-msg').classList.toggle('hidden', !isSpectator || isSetup);
            document.getElementById('btn-share').classList.toggle('hidden', isSetup || isSpectator);

            // Populate UI Elements
            document.getElementById('ui-p1-name').textContent = matchState.p1;
            document.getElementById('ui-p2-name').textContent = matchState.p2;
            document.getElementById('btn-p1-label').textContent = matchState.p1;
            document.getElementById('btn-p2-label').textContent = matchState.p2;
            document.getElementById('ui-p1-srv').textContent = matchState.srv === 1 ? 'üéæ' : '';
            document.getElementById('ui-p2-srv').textContent = matchState.srv === 2 ? 'üéæ' : '';

            // Handle Column Visibility for Format
            const rules = getRules();
            document.querySelectorAll('[data-col]').forEach(el => {
                const c = parseInt(el.getAttribute('data-col'));
                if (rules.isPro && c > 1) {
                    el.classList.add('invisible-col');
                } else {
                    el.classList.remove('invisible-col');
                }
            });

            for(let i=0; i<3; i++) {
                document.getElementById(`ui-p1-s${i+1}`).textContent = matchState.games[i][0];
                document.getElementById(`ui-p2-s${i+1}`).textContent = matchState.games[i][1];
            }

            const getPointStr = (p, o) => matchState.tie ? p : (p === 3 && o === 3 ? 'Deuce' : scoreStrings[p]);
            document.getElementById('ui-p1-game').textContent = getPointStr(matchState.score[0], matchState.score[1]);
            document.getElementById('ui-p2-game').textContent = getPointStr(matchState.score[1], matchState.score[0]);

            document.getElementById('meta-id').textContent = `Match: ${matchState.id}`;
            document.getElementById('meta-loc').textContent = `Loc: ${matchState.loc}`;
            
            const banner = document.getElementById('match-status-banner');
            if (matchState.status === "ENDED") {
                const winner = matchState.setsWon[0] > matchState.setsWon[1] ? matchState.p1 : matchState.p2;
                banner.innerHTML = `<span class="text-green-500">üèÜ ${winner} Wins!</span>`;
            } else {
                banner.textContent = `Set ${matchState.set + 1} - ${matchState.fmt.toUpperCase()}`;
            }

            handleLiveTimer();
        }

        function handleLiveTimer() {
            const el = document.getElementById('timer-display');
            if (!matchState.start) return;
            if (matchState.status === "PLAYING" && !liveDurationInterval) {
                liveDurationInterval = setInterval(() => {
                    const diff = Date.now() - matchState.start;
                    el.textContent = new Date(diff).toISOString().substr(11, 8);
                }, 1000);
            } else if (matchState.status !== "PLAYING") {
                clearInterval(liveDurationInterval);
                liveDurationInterval = null;
            }
        }

        // --- BUTTON ACTIONS ---
        window.startMatch = async function() {
            if (!auth.currentUser) return;

            const p1 = document.getElementById('setup-p1').value.trim() || "P1";
            const p2 = document.getElementById('setup-p2').value.trim() || "P2";
            const loc = document.getElementById('setup-loc').value.trim() || "Park Court";
            const fmt = document.querySelector('input[name="fmt"]:checked').value;
            const srv = parseInt(document.querySelector('input[name="srv"]:checked').value);

            matchState = {
                id: auth.currentUser.uid.substr(0,4) + '-' + Math.floor(Math.random()*9000+1000),
                status: "PLAYING", p1, p2, loc, fmt, srv,
                set: 0, setsWon: [0,0], games: [[0,0],[0,0],[0,0]], score: [0,0],
                history: [], start: Date.now(), end: null, tie: false
            };
            
            await syncState();
        };

        window.toggleModal = function(type) {
            const m = document.getElementById('modal-data');
            m.classList.remove('hidden'); m.style.display = 'flex';
            const cont = document.getElementById('modal-content');
            document.getElementById('modal-title').textContent = type === 'history' ? 'Archive' : 'Statistics';
            
            if (type === 'stats') {
                const p1 = matchState.history.filter(x => x.w === matchState.p1).length;
                const p2 = matchState.history.filter(x => x.w === matchState.p2).length;
                cont.innerHTML = `<div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-indigo-50 p-6 rounded-3xl"><b>${matchState.p1}</b><br><span class="text-3xl font-black">${p1}</span> pts</div>
                    <div class="bg-indigo-50 p-6 rounded-3xl"><b>${matchState.p2}</b><br><span class="text-3xl font-black">${p2}</span> pts</div>
                </div>`;
            } else {
                cont.innerHTML = "Loading history...";
                db.collection(`artifacts/${appId}/public/data/matches`).orderBy('start', 'desc').limit(5).get().then(snap => {
                    cont.innerHTML = "";
                    snap.forEach(doc => {
                        const d = doc.data();
                        const div = document.createElement('div');
                        div.className = "p-5 bg-slate-50 border rounded-3xl cursor-pointer hover:border-indigo-400 transition-all";
                        div.innerHTML = `<div class="text-[9px] font-black text-slate-400 uppercase mb-1">${d.loc}</div><div class="font-bold">${d.p1} vs ${d.p2}</div>`;
                        div.onclick = () => { window.location.search = `?matchId=${doc.id}&mode=spectate`; };
                        cont.appendChild(div);
                    });
                });
            }
        };

        window.closeModals = () => {
            const m = document.getElementById('modal-data');
            m.classList.add('hidden'); m.style.display = 'none';
        };

        window.exportCSV = () => {
            if (!matchState.history.length) return;
            let csv = "Time,Winner,Serve,Type,Rally\n";
            matchState.history.forEach(h => csv += `${new Date(h.time).toLocaleTimeString()},"${h.w}",${h.s},${h.t},${h.r}\n`);
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `match_${matchState.id}.csv`; a.click();
        };

        window.copyShareLink = () => {
            const url = `${window.location.origin}${window.location.pathname}?matchId=${matchState.id}&mode=spectate`;
            const el = document.createElement('textarea'); el.value = url; document.body.appendChild(el);
            el.select(); document.execCommand('copy'); document.body.removeChild(el);
            alert("Spectator link copied to clipboard!");
        };

        window.undo = () => alert("Logic synchronization active. For score errors, please use Reset.");
        window.resetMatch = () => { if(confirm("New match setup?")) window.location.search = ""; };

        // --- AUTH & INITIALIZATION ---
        window.addEventListener('load', () => {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            appId = firebaseConfig.projectId;

            auth.onAuthStateChanged(async (user) => {
                if(!user) { await auth.signInAnonymously(); return; }
                const params = new URLSearchParams(window.location.search);
                const mid = params.get('matchId');
                
                if (mid) {
                    db.collection(`artifacts/${appId}/public/data/matches`).doc(mid).onSnapshot(doc => {
                        if (doc.exists) {
                            const d = doc.data();
                            d.games = typeof d.games === 'string' ? JSON.parse(d.games) : d.games;
                            matchState = d;
                            renderUI();
                        }
                    });
                } else {
                    renderUI();
                }
            });
        });
    </script>
</body>
</html>