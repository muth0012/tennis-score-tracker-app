<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Score Tracker Pro</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Google Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Rigid layout to keep Game Score column on the far right */
        .table-rigid { table-layout: fixed; width: 100%; border-collapse: collapse; }
        .col-p { width: 30%; }
        .col-s { width: 12%; }
        .col-g { width: 34%; }

        .log-item { border-bottom: 1px solid #f1f5f9; padding: 4px 0; }
        .modal-bg { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(4px); }
        
        /* Analytics Styling */
        .analytics-section-title { font-size: 0.75rem; font-weight: 800; color: #6366f1; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; border-bottom: 2px solid #eef2ff; padding-bottom: 4px; }
        .stats-table { width: 100%; font-size: 0.875rem; margin-bottom: 1.5rem; }
        .stats-table th { text-align: left; color: #64748b; padding: 4px 8px; font-weight: 600; border-bottom: 1px solid #f1f5f9; }
        .stats-table td { padding: 6px 8px; border-bottom: 1px solid #f8fafc; }
        .stats-table tr:last-child td { border-bottom: none; }
        .stat-val { font-family: 'ui-monospace', monospace; font-weight: 700; color: #1e293b; }
    </style>

    <!-- Load Firebase v8 SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 p-4 min-h-screen">

    <div id="app-container" class="max-w-2xl mx-auto">
        <!-- Header -->
        <div class="mb-6 p-4 bg-white shadow-lg rounded-xl border border-gray-200">
            <h1 class="text-3xl font-bold text-center text-indigo-700 mb-2">Tennis Tracker</h1>
            <p id="match-status-banner" class="text-center font-semibold text-xs text-gray-500 uppercase tracking-widest"></p>
            <div class="flex justify-center text-[10px] text-gray-400 space-x-4 mt-2 font-mono">
                <p>Match: <span id="ui-match-id">---</span></p>
                <p id="timer-ui" class="font-bold text-indigo-600 hidden"></p>
            </div>
        </div>

        <!-- Scoreboard (Fixed Column Widths) -->
        <div id="scoreboard-area" class="bg-white shadow-xl rounded-xl border border-gray-200 overflow-hidden mb-6 hidden">
            <table class="table-rigid text-center">
                <thead>
                    <tr class="bg-indigo-600 text-white text-[10px] uppercase tracking-tighter">
                        <th class="col-p p-3 text-left pl-4">Player</th>
                        <th class="col-s" data-s-header="1">S1</th>
                        <th class="col-s" data-s-header="2">S2</th>
                        <th class="col-s" data-s-header="3">S3</th>
                        <th class="col-g">Game Score</th>
                    </tr>
                </thead>
                <tbody class="text-lg">
                    <tr class="border-b border-gray-100">
                        <td id="p1-name-ui" class="p-4 font-bold text-left pl-4 flex items-center justify-between truncate">
                            <span>P1</span>
                            <span id="p1-srv-ui"></span>
                        </td>
                        <td id="p1-s1-ui" data-s-cell="1" class="font-mono text-gray-900">0</td>
                        <td id="p1-s2-ui" data-s-cell="2" class="font-mono text-gray-900">0</td>
                        <td id="p1-s3-ui" data-s-cell="3" class="font-mono text-gray-900">0</td>
                        <td id="p1-game-pts" class="text-2xl font-black text-indigo-700 bg-indigo-50/50">0</td>
                    </tr>
                    <tr>
                        <td id="p2-name-ui" class="p-4 font-bold text-left pl-4 flex items-center justify-between truncate">
                            <span>P2</span>
                            <span id="p2-srv-ui"></span>
                        </td>
                        <td id="p2-s1-ui" data-s-cell="1" class="font-mono text-gray-900">0</td>
                        <td id="p2-s2-ui" data-s-cell="2" class="font-mono text-gray-900">0</td>
                        <td id="p2-s3-ui" data-s-cell="3" class="font-mono text-gray-900">0</td>
                        <td id="p2-game-pts" class="text-2xl font-black text-indigo-700 bg-indigo-50/50">0</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Controls -->
        <div id="controls-area" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
            <!-- Point Entry -->
            <div class="bg-white p-5 shadow-xl rounded-2xl border border-gray-100">
                <h2 class="text-xs font-black text-gray-400 uppercase mb-4 tracking-widest">Point Entry</h2>
                <div class="space-y-3">
                    <div class="flex items-center space-x-3">
                        <label class="text-xs font-bold w-20">1st Serve</label>
                        <select id="in-serve" class="flex-grow p-2 bg-gray-50 border rounded-lg text-sm font-semibold">
                            <option value="IN">In</option>
                            <option value="FAULT">Fault</option>
                            <option value="ACE">Ace</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-3">
                        <label class="text-xs font-bold w-20">Strokes</label>
                        <input type="number" id="in-rally" value="1" min="1" class="flex-grow p-2 bg-gray-50 border rounded-lg text-sm font-semibold">
                    </div>
                    <div class="flex items-center space-x-3">
                        <label class="text-xs font-bold w-20">Type</label>
                        <select id="in-type" class="flex-grow p-2 bg-gray-50 border rounded-lg text-sm font-semibold">
                            <option value="W-G">Winner (Groundstroke)</option>
                            <option value="W-V">Winner (Volley)</option>
                            <option value="W-D">Winner (Drop Shot)</option>
                            <option value="UE">Unforced Error</option>
                            <option value="ACE">Ace</option>
                            <option value="DF">Double Fault</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 grid grid-cols-2 gap-3">
                    <button onclick="recordPointForPlayer(1)" class="p-4 bg-indigo-600 text-white rounded-xl font-bold shadow-md hover:bg-indigo-700 active:scale-95 transition">Point P1</button>
                    <button onclick="recordPointForPlayer(2)" class="p-4 bg-indigo-600 text-white rounded-xl font-bold shadow-md hover:bg-indigo-700 active:scale-95 transition">Point P2</button>
                </div>
            </div>

            <!-- Utility & Logs -->
            <div class="bg-white p-5 shadow-xl rounded-2xl border border-gray-100 flex flex-col">
                <h2 class="text-xs font-black text-gray-400 uppercase mb-4 tracking-widest">History & Utility</h2>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button onclick="undo()" class="p-2 bg-amber-500 text-white rounded-lg text-xs font-bold hover:bg-amber-600">Undo Last</button>
                    <button onclick="endMatchManually()" class="p-2 bg-rose-500 text-white rounded-lg text-xs font-bold hover:bg-rose-600">End Match</button>
                    <button onclick="openDataModal('history')" class="p-2 bg-slate-700 text-white rounded-lg text-xs font-bold hover:bg-slate-800">Archive</button>
                    <button onclick="openDataModal('stats')" class="p-2 bg-teal-600 text-white rounded-lg text-xs font-bold hover:bg-teal-700">Analytics</button>
                </div>
                <div class="flex-grow border-t pt-3 overflow-hidden">
                    <p class="text-[10px] font-black text-gray-400 uppercase mb-2">Last 10 Points</p>
                    <div id="live-log-ui" class="text-[10px] space-y-1 overflow-y-auto max-h-24 pr-2"></div>
                </div>
            </div>
        </div>

        <!-- Footers -->
        <div class="mt-6 space-y-3 text-center">
            <button id="btn-share" onclick="copyShareLink()" class="hidden w-full py-4 bg-green-500 text-white rounded-2xl font-bold shadow-lg shadow-green-100 active:scale-95 transition">Copy Live Score Link</button>
            <button onclick="exportCSV()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold text-sm">Download CSV Report</button>
            <button onclick="resetApp()" class="w-full py-3 text-rose-500 font-bold text-sm bg-white border border-rose-100 rounded-xl">Start New Match</button>
            <p class="text-[9px] text-gray-300 font-medium tracking-widest uppercase">Tennis Tracker Pro v1.7</p>
        </div>
    </div>

    <!-- SETUP MODAL -->
    <div id="modal-setup" class="fixed inset-0 modal-bg flex items-center justify-center p-6 z-[100]">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl">
            <h2 class="text-3xl font-black text-slate-800 mb-8 tracking-tighter text-center">Match Setup</h2>
            <div class="space-y-4">
                <input type="text" id="set-p1" placeholder="Player 1 Name" class="w-full bg-slate-50 border p-4 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                <input type="text" id="set-p2" placeholder="Player 2 Name" class="w-full bg-slate-50 border p-4 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                <input type="text" id="set-loc" placeholder="Match Location" class="w-full bg-slate-50 border p-4 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                
                <div>
                    <p class="text-[10px] font-black text-slate-400 uppercase mb-2 ml-2">Match Format</p>
                    <div class="grid grid-cols-1 gap-2 p-4 bg-indigo-50 rounded-2xl">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="radio" name="fmt" value="pro-no"> <span class="text-xs font-bold text-slate-700">8G Pro-Set (No-Ad)</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="radio" name="fmt" value="pro-ad" checked> <span class="text-xs font-bold text-slate-700">8G Pro-Set (Ad)</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="radio" name="fmt" value="b3-no"> <span class="text-xs font-bold text-slate-700">Best of 3 (No-Ad)</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="radio" name="fmt" value="b3-ad"> <span class="text-xs font-bold text-slate-700">Best of 3 (Ad)</span>
                        </label>
                    </div>
                </div>

                <div class="flex justify-between items-center bg-slate-50 p-4 rounded-3xl border">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Starter</span>
                    <div class="flex space-x-2">
                        <label class="cursor-pointer"><input type="radio" name="srv" value="1" checked class="peer sr-only"><div class="peer-checked:bg-indigo-600 peer-checked:text-white px-4 py-2 bg-white border rounded-xl text-xs font-bold shadow-sm transition">P1</div></label>
                        <label class="cursor-pointer"><input type="radio" name="srv" value="2" class="peer sr-only"><div class="peer-checked:bg-indigo-600 peer-checked:text-white px-4 py-2 bg-white border rounded-xl text-xs font-bold shadow-sm transition">P2</div></label>
                    </div>
                </div>

                <button onclick="startMatchNow()" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-bold shadow-2xl active:scale-95 transition text-lg mt-4">Start Match</button>
            </div>
        </div>
    </div>

    <!-- MODAL: DATA -->
    <div id="modal-data" class="fixed inset-0 modal-bg hidden items-center justify-center p-4 z-[110]">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] p-8 flex flex-col max-h-[95vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-black text-indigo-700">Match Data</h2>
                <button onclick="closeDataModal()" class="text-slate-400 text-3xl hover:text-slate-900 transition-colors">&times;</button>
            </div>
            <div id="modal-content" class="overflow-y-auto space-y-6 pr-2"></div>
        </div>
    </div>

    <script>
        // --- GLOBALS ---
        let liveDurationInterval = null;
        let db, auth, appId;
        const ptsStrings = { 0: '0', 1: '15', 2: '30', 3: '40', 4: 'Ad' };

        const config = {
            apiKey: "AIzaSyBOdTC5Q8MmbDhlNGlpm-EFQgJFZebIUZI",
            authDomain: "tennis-score-tracker-bd317.firebaseapp.com",
            projectId: "tennis-score-tracker-bd317",
            storageBucket: "tennis-score-tracker-bd317.firebasestorage.app",
            messagingSenderId: "301275539476",
            appId: "1:301275539476:web:6ae1032d7d23f7c699df01"
        };

        let state = {
            id: "", status: "SETUP", p1: "P1", p2: "P2", loc: "", fmt: "pro-ad",
            srv: 1, set: 0, setsWon: [0,0], games: [[0,0],[0,0],[0,0]], score: [0,0],
            history: [], start: null, end: null, tie: false
        };

        // --- ENGINE ---
        function getRules() {
            const isPro = state.fmt.startsWith('pro');
            return {
                isPro,
                winGames: isPro ? 8 : 6,
                targetSets: isPro ? 1 : 2,
                isAd: state.fmt.endsWith('ad')
            };
        }

        window.recordPointForPlayer = function(winner) {
            if (state.status !== 'PLAYING') return;

            // SNAPSHOT FOR UNDO
            const prePointSnapshot = {
                score: [...state.score],
                games: JSON.parse(JSON.stringify(state.games)),
                setsWon: [...state.setsWon],
                set: state.set,
                srv: state.srv,
                tie: state.tie,
                status: state.status
            };

            const idx = winner - 1;
            const opp = idx === 0 ? 1 : 0;
            const rules = getRules();

            const entry = {
                w: winner === 1 ? state.p1 : state.p2,
                idx: winner,
                srv: state.srv, 
                s: document.getElementById('in-serve').value,
                r: parseInt(document.getElementById('in-rally').value) || 1,
                t: document.getElementById('in-type').value,
                time: Date.now(),
                snapshot: prePointSnapshot // Attach snapshot to history
            };

            if (state.tie) {
                state.score[idx]++;
                if (state.score[idx] >= 7 && (state.score[idx] - state.score[opp] >= 2)) finishGame(winner);
            } else if (rules.isAd) {
                // FIXED AD LOGIC
                if (state.score[idx] === 3 && state.score[opp] < 3) finishGame(winner);
                else if (state.score[idx] === 3 && state.score[opp] === 3) state.score[idx] = 4;
                else if (state.score[idx] === 4) finishGame(winner);
                else if (state.score[opp] === 4) state.score[opp] = 3;
                else state.score[idx]++;
            } else {
                state.score[idx]++;
                if (state.score[idx] === 4) finishGame(winner);
            }

            state.history.push(entry);
            persistAndRender();
        };

        function finishGame(winner) {
            state.games[state.set][winner-1]++;
            state.score = [0,0];
            state.tie = false;
            state.srv = (state.srv === 1) ? 2 : 1;

            const rules = getRules();
            const g1 = state.games[state.set][0];
            const g2 = state.games[state.set][1];

            if ((g1 >= rules.winGames || g2 >= rules.winGames) && Math.abs(g1 - g2) >= 2) {
                state.setsWon[winner-1]++;
                if (state.setsWon[winner-1] === rules.targetSets) {
                    state.status = "ENDED"; state.end = Date.now();
                } else state.set++;
            } else if (g1 === rules.winGames && g2 === rules.winGames) {
                state.tie = true;
            }
        }

        // --- UI & SYNC ---
        async function persistAndRender() {
            render();
            if (!state.id || !db) return;
            const data = JSON.parse(JSON.stringify(state));
            data.games = JSON.stringify(data.games);
            await db.collection(`artifacts/${appId}/public/data/matches`).doc(state.id).set(data);
        }

        function formatDuration(ms) {
            const s = Math.floor(ms / 1000);
            const m = Math.floor(s / 60);
            const h = Math.floor(m / 60);
            if (isNaN(s)) return '0:00';
            return `${h > 0 ? h + ':' : ''}${String(m % 60).padStart(2, '0')}:${String(s % 60).padStart(2, '0')}`;
        }

        function render() {
            const isSpec = new URLSearchParams(window.location.search).get('mode') === 'spectate';
            const setup = state.status === "SETUP";

            document.getElementById('modal-setup').style.display = (setup && !isSpec) ? 'flex' : 'none';
            document.getElementById('scoreboard-area').classList.toggle('hidden', setup);
            document.getElementById('controls-area').classList.toggle('hidden', setup || isSpec);
            document.getElementById('btn-share').classList.toggle('hidden', setup || isSpec);

            document.getElementById('p1-name-ui').children[0].textContent = state.p1;
            document.getElementById('p2-name-ui').children[0].textContent = state.p2;
            document.getElementById('p1-srv-ui').textContent = state.srv === 1 ? 'ðŸŽ¾' : '';
            document.getElementById('p2-srv-ui').textContent = state.srv === 2 ? 'ðŸŽ¾' : '';

            const rules = getRules();
            document.querySelectorAll('[data-s-header], [data-s-cell]').forEach(el => {
                const s = parseInt(el.getAttribute('data-s-header') || el.getAttribute('data-s-cell'));
                el.style.display = (rules.isPro && s > 1) ? 'none' : 'table-cell';
            });

            for(let i=0; i<3; i++) {
                document.getElementById(`p1-s${i+1}-ui`).textContent = state.games[i][0];
                document.getElementById(`p2-s${i+1}-ui`).textContent = state.games[i][1];
            }

            const getPts = (p, o) => state.tie ? p : (p === 3 && o === 3 ? 'Deuce' : ptsStrings[p]);
            document.getElementById('p1-game-pts').textContent = getPts(state.score[0], state.score[1]);
            document.getElementById('p2-game-pts').textContent = getPts(state.score[1], state.score[0]);

            document.getElementById('match-status-banner').textContent = `${state.status} | ${state.fmt.toUpperCase()} @ ${state.loc || 'Court'}`;
            document.getElementById('ui-match-id').textContent = state.id;

            renderLiveLog();
            handleTimer();
        }

        function renderLiveLog() {
            const box = document.getElementById('live-log-ui');
            if (!state.history.length) return box.innerHTML = '<p class="text-slate-300 italic">No points yet...</p>';
            box.innerHTML = state.history.slice(-10).reverse().map(h => 
                `<div class="log-item"><b>${h.w}</b> won via ${h.t} <span class="text-gray-400 font-mono text-[8px]">(Strokes: ${h.r})</span></div>`
            ).join('');
        }

        function handleTimer() {
            const el = document.getElementById('timer-ui');
            if(!state.start) return;
            el.classList.remove('hidden');
            if(state.status === "PLAYING" && !liveDurationInterval) {
                liveDurationInterval = setInterval(() => {
                    const elapsed = Date.now() - state.start;
                    el.textContent = formatDuration(elapsed);
                }, 1000);
            } else if (state.status !== "PLAYING") {
                clearInterval(liveDurationInterval);
                liveDurationInterval = null;
                const total = (state.end || Date.now()) - state.start;
                el.textContent = "Duration: " + formatDuration(total);
            }
        }

        // --- BUTTONS ---
        window.startMatchNow = function() {
            const p1 = document.getElementById('set-p1').value || "Player 1";
            const p2 = document.getElementById('set-p2').value || "Player 2";
            const loc = document.getElementById('set-loc').value || "Court";
            const fmt = document.querySelector('input[name="fmt"]:checked').value;
            const srv = parseInt(document.querySelector('input[name="srv"]:checked').value);

            state = {
                id: (auth.currentUser ? auth.currentUser.uid.substr(0,4) : 'local') + '-' + Math.floor(Math.random()*9000+1000),
                status: "PLAYING", p1, p2, loc, fmt, srv,
                set: 0, setsWon: [0,0], games: [[0,0],[0,0],[0,0]], score: [0,0],
                history: [], start: Date.now(), end: null, tie: false
            };
            persistAndRender();
        };

        window.undo = function() {
            if (state.history.length === 0) return;
            
            // Pop the last point from history
            const lastPoint = state.history.pop();
            
            // Restore the state from the snapshot taken before that point
            if (lastPoint.snapshot) {
                const snap = lastPoint.snapshot;
                state.score = snap.score;
                state.games = snap.games;
                state.setsWon = snap.setsWon;
                state.set = snap.set;
                state.srv = snap.srv;
                state.tie = snap.tie;
                state.status = snap.status;
                state.end = null; // Clear end time if we are undoing a match-ending point
                
                persistAndRender();
            }
        };

        window.endMatchManually = () => { if(confirm("End match manually?")) { state.status = "ENDED"; state.end = Date.now(); persistAndRender(); } };
        
        window.openDataModal = function(type) {
            const m = document.getElementById('modal-data');
            m.classList.remove('hidden'); m.style.display = 'flex';
            document.getElementById('modal-title').textContent = type === 'history' ? 'Match Archive' : 'Match Analytics';
            const cont = document.getElementById('modal-content');
            
            if(type === 'stats') {
                const h = state.history;
                const getStat = (pIdx, typeVal) => h.filter(x => x.idx === pIdx && x.t === typeVal).length;
                const getAces = (pIdx) => h.filter(x => x.idx === pIdx && (x.t === 'ACE' || x.s === 'ACE')).length;
                const getDFs = (pIdx) => h.filter(x => x.idx === pIdx && x.t === 'DF').length;
                const getTotalPts = (pIdx) => h.filter(x => x.idx === pIdx).length;
                
                const getServedCount = (pIdx) => h.filter(x => x.srv === pIdx).length;
                const getFirstInCount = (pIdx) => h.filter(x => x.srv === pIdx && (x.s === 'IN' || x.s === 'ACE')).length;
                const getPtsWonOnServe = (pIdx) => h.filter(x => x.srv === pIdx && x.idx === pIdx).length;

                const totalStrokes = h.reduce((acc, val) => acc + (val.r || 0), 0);
                const avgRally = h.length ? (totalStrokes / h.length).toFixed(1) : 0;
                
                const totalDuration = (state.end || Date.now()) - state.start;
                const totalGames = state.setsWon[0] + state.setsWon[1] + (JSON.parse(JSON.stringify(state.games)).reduce((a,b) => a + b[0] + b[1], 0));
                const timePerGame = totalGames ? formatDuration(totalDuration / totalGames) : '0:00';

                const statsData = (pIdx) => ({
                    winners: getStat(pIdx, 'W-G') + getStat(pIdx, 'W-V') + getStat(pIdx, 'W-D') + getAces(pIdx),
                    ground: getStat(pIdx, 'W-G'),
                    volley: getStat(pIdx, 'W-V'),
                    drop: getStat(pIdx, 'W-D'),
                    onServe: getServedCount(pIdx) ? Math.round((getPtsWonOnServe(pIdx) / getServedCount(pIdx)) * 100) : 0,
                    firstIn: getServedCount(pIdx) ? Math.round((getFirstInCount(pIdx) / getServedCount(pIdx)) * 100) : 0
                });

                const s1 = statsData(1);
                const s2 = statsData(2);

                cont.innerHTML = `
                    <div class="analytics-section-title">Match Pace & Duration</div>
                    <table class="stats-table">
                        <tr><td>Total Duration</td><td class="stat-val text-right">${formatDuration(totalDuration)}</td></tr>
                        <tr><td>Total Games Played</td><td class="stat-val text-right">${totalGames}</td></tr>
                        <tr><td>Avg Time Per Game</td><td class="stat-val text-right">${timePerGame}</td></tr>
                        <tr><td>Avg Rally Length</td><td class="stat-val text-right">${avgRally} shots</td></tr>
                    </table>

                    <div class="analytics-section-title">Point Breakdown</div>
                    <table class="stats-table">
                        <thead><tr><th>Metric</th><th class="text-center">${state.p1}</th><th class="text-center">${state.p2}</th></tr></thead>
                        <tbody>
                            <tr><td>Total Winners</td><td class="stat-val text-center">${s1.winners}</td><td class="stat-val text-center">${s2.winners}</td></tr>
                            <tr><td>Groundstroke Wins</td><td class="stat-val text-center">${s1.ground}</td><td class="stat-val text-center">${s2.ground}</td></tr>
                            <tr><td>Volley Winners</td><td class="stat-val text-center">${s1.volley}</td><td class="stat-val text-center">${s2.volley}</td></tr>
                            <tr><td>Drop Shot Wins</td><td class="stat-val text-center">${s1.drop}</td><td class="stat-val text-center">${s2.drop}</td></tr>
                            <tr><td>Unforced Errors</td><td class="stat-val text-center">${getStat(1, 'UE')}</td><td class="stat-val text-center">${getStat(2, 'UE')}</td></tr>
                            <tr><td>Double Faults</td><td class="stat-val text-center">${getStat(1, 'DF')}</td><td class="stat-val text-center">${getStat(2, 'DF')}</td></tr>
                            <tr><td class="font-bold">Total Points</td><td class="stat-val text-center font-bold text-indigo-600">${getTotalPts(1)}</td><td class="stat-val text-center font-bold text-indigo-600">${getTotalPts(2)}</td></tr>
                        </tbody>
                    </table>

                    <div class="analytics-section-title">Serve Performance</div>
                    <table class="stats-table">
                        <thead><tr><th>Metric</th><th class="text-center">${state.p1}</th><th class="text-center">${state.p2}</th></tr></thead>
                        <tbody>
                            <tr><td>Points Won on Serve</td><td class="stat-val text-center">${s1.onServe}%</td><td class="stat-val text-center">${s2.onServe}%</td></tr>
                            <tr><td>1st Serve In</td><td class="stat-val text-center">${s1.firstIn}%</td><td class="stat-val text-center">${s2.firstIn}%</td></tr>
                            <tr><td>Aces</td><td class="stat-val text-center">${getAces(1)}</td><td class="stat-val text-center">${getAces(2)}</td></tr>
                            <tr><td>Double Faults</td><td class="stat-val text-center">${getStat(1, 'DF')}</td><td class="stat-val text-center">${getStat(2, 'DF')}</td></tr>
                        </tbody>
                    </table>
                `;
            } else {
                cont.innerHTML = "<p class='text-center p-4 text-xs font-bold text-slate-400'>Syncing archive...</p>";
                db.collection(`artifacts/${appId}/public/data/matches`).orderBy('start', 'desc').limit(8).get().then(snap => {
                    cont.innerHTML = "";
                    if(snap.empty) cont.innerHTML = "<p class='text-center p-4 text-slate-400 italic'>No match archive found.</p>";
                    snap.forEach(doc => {
                        const d = doc.data();
                        const div = document.createElement('div');
                        div.className = "p-5 bg-slate-50 border border-slate-200 rounded-3xl cursor-pointer hover:border-indigo-400 shadow-sm transition-all";
                        div.innerHTML = `<div class="flex justify-between items-start"><div><div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${d.loc} | ${d.fmt}</div><div class="font-bold text-slate-800">${d.p1} vs ${d.p2}</div></div><div class="text-[10px] text-indigo-500 font-bold bg-indigo-50 px-2 py-1 rounded-full">${d.status}</div></div>`;
                        div.onclick = () => { window.location.search = `?matchId=${doc.id}&mode=spectate`; };
                        cont.appendChild(div);
                    });
                });
            }
        };

        window.closeDataModal = () => { document.getElementById('modal-data').classList.add('hidden'); document.getElementById('modal-data').style.display = 'none'; };

        window.exportCSV = () => {
            if(!state.history.length) return;
            let csv = "Winner,Type,ServeResult,Strokes,Timestamp\n";
            state.history.forEach(h => csv += `"${h.w}",${h.t},${h.s},${h.r},${new Date(h.time).toLocaleTimeString()}\n`);
            const b = new Blob([csv], {type:'text/csv'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `match-${state.id}.csv`; a.click();
        };

        window.copyShareLink = () => {
            const url = `${window.location.origin}${window.location.pathname}?matchId=${state.id}&mode=spectate`;
            
            // Robust fallback method for copying to clipboard
            const textArea = document.createElement("textarea");
            textArea.value = url;
            
            // Ensure the textarea is off-screen but still part of the DOM
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert("Live spectator link copied to clipboard!");
                } else {
                    prompt("Copy this link to share:", url);
                }
            } catch (err) {
                prompt("Copy this link to share:", url);
            }
            
            document.body.removeChild(textArea);
        };

        window.resetApp = () => { if(confirm("Start a completely new match?")) window.location.search = ""; };

        // --- AUTH & INIT ---
        window.addEventListener('load', () => {
            firebase.initializeApp(config);
            db = firebase.firestore();
            auth = firebase.auth();
            appId = config.projectId;

            auth.onAuthStateChanged(async (user) => {
                if(!user) { await auth.signInAnonymously(); return; }
                const mid = new URLSearchParams(window.location.search).get('matchId');
                if(mid) {
                    db.collection(`artifacts/${appId}/public/data/matches`).doc(mid).onSnapshot(doc => {
                        if(doc.exists) { 
                            const d = doc.data(); 
                            d.games = typeof d.games === 'string' ? JSON.parse(d.games) : d.games;
                            state = d; render(); 
                        }
                    });
                } else render();
            });
        });
    </script>
</body>
</html>