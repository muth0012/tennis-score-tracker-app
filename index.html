<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Tracker - Stable Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Rigid 5-Column Grid System: Name | S1 | S2 | S3 | Game Score */
        .score-grid {
            display: grid;
            grid-template-columns: 2.5fr 0.8fr 0.8fr 0.8fr 2fr;
            align-items: center;
            text-align: center;
        }

        .custom-shadow { box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1); }
        .modal-overlay { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); }
        .debug-text { font-family: 'Courier New', Courier, monospace; font-size: 11px; }
    </style>

    <!-- Firebase v8 SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body class="bg-slate-100 text-slate-900 min-h-screen pb-12">

    <div id="app-container" class="max-w-lg mx-auto px-4 pt-6">
        <!-- Persistent Header -->
        <header class="bg-white rounded-3xl p-6 mb-4 border border-slate-200 custom-shadow">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-2xl font-black text-indigo-600 tracking-tighter">Tennis Tracker</h1>
                <div id="timer-display" class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-[10px] font-black font-mono">00:00:00</div>
            </div>
            <div class="flex justify-between text-[9px] text-slate-400 font-bold uppercase tracking-widest border-t border-slate-50 pt-3">
                <span id="meta-id">Match: ---</span>
                <span id="meta-loc">Loc: ---</span>
            </div>
        </header>

        <!-- Scoreboard -->
        <section id="scoreboard-area" class="bg-white rounded-3xl overflow-hidden mb-6 border border-slate-200 shadow-xl hidden">
            <div class="score-grid bg-slate-800 text-white text-[9px] font-black uppercase tracking-widest p-3">
                <div class="text-left pl-3">Competitor</div>
                <div>S1</div><div>S2</div><div>S3</div>
                <div>Game</div>
            </div>
            <!-- P1 Row -->
            <div class="score-grid border-b border-slate-50 py-5 px-2 items-center">
                <div class="text-left pl-3 font-bold text-slate-700 flex items-center truncate">
                    <span id="ui-p1-name">P1</span>
                    <span id="ui-p1-srv" class="ml-2 text-indigo-500"></span>
                </div>
                <div id="ui-p1-s1" class="font-mono text-slate-400 font-bold text-lg">0</div>
                <div id="ui-p1-s2" class="font-mono text-slate-400 font-bold text-lg">0</div>
                <div id="ui-p1-s3" class="font-mono text-slate-400 font-bold text-lg">0</div>
                <div id="ui-p1-game" class="font-black text-indigo-600 text-2xl">0</div>
            </div>
            <!-- P2 Row -->
            <div class="score-grid py-5 px-2 items-center">
                <div class="text-left pl-3 font-bold text-slate-700 flex items-center truncate">
                    <span id="ui-p2-name">P2</span>
                    <span id="ui-p2-srv" class="ml-2 text-indigo-500"></span>
                </div>
                <div id="ui-p2-s1" class="font-mono text-slate-400 font-bold text-lg">0</div>
                <div id="ui-p2-s2" class="font-mono text-slate-400 font-bold text-lg">0</div>
                <div id="ui-p2-s3" class="font-mono text-slate-400 font-bold text-lg">0</div>
                <div id="ui-p2-game" class="font-black text-indigo-600 text-2xl">0</div>
            </div>
        </section>

        <!-- Scoring Controls -->
        <section id="scoring-controls" class="space-y-4 hidden">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="submitPoint(1)" class="bg-indigo-600 text-white p-7 rounded-[2rem] shadow-lg active:scale-95 transition-transform">
                    <span id="btn-p1-label" class="block font-bold truncate text-xl">P1 Point</span>
                </button>
                <button onclick="submitPoint(2)" class="bg-indigo-600 text-white p-7 rounded-[2rem] shadow-lg active:scale-95 transition-transform">
                    <span id="btn-p2-label" class="block font-bold truncate text-xl">P2 Point</span>
                </button>
            </div>

            <!-- Meta Details -->
            <div class="bg-white p-4 rounded-[2rem] border border-slate-200 shadow-sm grid grid-cols-3 gap-3">
                <div class="flex flex-col"><label class="text-[9px] font-black text-slate-400 uppercase mb-1">Serve</label>
                    <select id="in-serve" class="bg-slate-50 border-none rounded-xl p-2 text-xs font-bold"><option value="IN">In</option><option value="FAULT">Fault</option><option value="ACE">Ace</option></select>
                </div>
                <div class="flex flex-col"><label class="text-[9px] font-black text-slate-400 uppercase mb-1">Rally</label>
                    <input type="number" id="in-rally" value="1" min="1" class="bg-slate-50 border-none rounded-xl p-2 text-xs font-bold">
                </div>
                <div class="flex flex-col"><label class="text-[9px] font-black text-slate-400 uppercase mb-1">Result</label>
                    <select id="in-type" class="bg-slate-50 border-none rounded-xl p-2 text-xs font-bold"><option value="W-G">Winner</option><option value="UE">Error</option><option value="ACE">Ace</option></select>
                </div>
            </div>
        </section>

        <!-- SYSTEM LOGS (Debug View) -->
        <div id="debug-container" class="mt-8 p-4 bg-slate-900 rounded-3xl overflow-hidden border border-slate-700 shadow-2xl">
            <div class="flex justify-between items-center mb-2">
                <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">System Logs</span>
                <div id="db-indicator" class="w-2 h-2 bg-red-500 rounded-full"></div>
            </div>
            <div id="debug-log" class="debug-text text-emerald-400 h-24 overflow-y-auto space-y-1"></div>
        </div>

        <div class="mt-6 space-y-2">
            <button id="btn-share" onclick="copyLink()" class="hidden w-full py-4 bg-emerald-500 text-white rounded-2xl font-bold shadow-lg">Copy Live Score Link</button>
            <button onclick="location.reload()" class="w-full py-4 text-slate-400 font-bold text-sm bg-white border border-slate-200 rounded-2xl">Reset / Setup New Match</button>
        </div>
    </div>

    <!-- MODAL: MATCH SETUP -->
    <div id="setup-modal" class="fixed inset-0 modal-overlay flex items-center justify-center p-6 z-[100]">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl">
            <h2 class="text-3xl font-black text-slate-800 mb-8 tracking-tighter text-center">Tennis Tracker</h2>
            <div class="space-y-4">
                <input type="text" id="p1-input" placeholder="Player 1 Name" class="w-full bg-slate-100 p-4 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="text" id="p2-input" placeholder="Player 2 Name" class="w-full bg-slate-100 p-4 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="text" id="loc-input" placeholder="Location" class="w-full bg-slate-100 p-4 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-indigo-500">
                
                <div class="grid grid-cols-2 gap-2">
                    <label class="cursor-pointer"><input type="radio" name="fmt" value="pro-ad" checked class="peer sr-only"><div class="peer-checked:bg-indigo-600 peer-checked:text-white bg-slate-100 text-slate-500 py-3 rounded-2xl text-[10px] font-black text-center uppercase transition-all">8G Pro (Ad)</div></label>
                    <label class="cursor-pointer"><input type="radio" name="fmt" value="b3-ad" class="peer sr-only"><div class="peer-checked:bg-indigo-600 peer-checked:text-white bg-slate-100 text-slate-500 py-3 rounded-2xl text-[10px] font-black text-center uppercase transition-all">Best of 3</div></label>
                </div>

                <div class="flex justify-between items-center bg-slate-50 p-4 rounded-3xl border border-slate-100">
                    <span class="text-[10px] font-black text-slate-400 uppercase">Starter</span>
                    <div class="flex space-x-2">
                        <label class="cursor-pointer"><input type="radio" name="srv" value="1" checked class="peer sr-only"><div class="peer-checked:bg-indigo-600 peer-checked:text-white w-10 h-10 flex items-center justify-center bg-white rounded-xl text-xs font-bold shadow-sm">P1</div></label>
                        <label class="cursor-pointer"><input type="radio" name="srv" value="2" class="peer sr-only"><div class="peer-checked:bg-indigo-600 peer-checked:text-white w-10 h-10 flex items-center justify-center bg-white rounded-xl text-xs font-bold shadow-sm">P2</div></label>
                    </div>
                </div>

                <button id="start-match-btn" onclick="startTheMatch()" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-bold shadow-2xl shadow-indigo-100 mt-4 text-lg">Start Match</button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBALS ---
        let liveDurationInterval = null;
        let db, auth;
        const appId = "tennis-tracker"; // Manual appId for pathing
        const ptsMap = { 0: '0', 1: '15', 2: '30', 3: '40', 4: 'Ad' };

        const firebaseConfig = {
            apiKey: "AIzaSyBOdTC5Q8MmbDhlNGlpm-EFQgJFZebIUZI",
            authDomain: "tennis-score-tracker-bd317.firebaseapp.com",
            projectId: "tennis-score-tracker-bd317",
            storageBucket: "tennis-score-tracker-bd317.firebasestorage.app",
            messagingSenderId: "301275539476",
            appId: "1:301275539476:web:6ae1032d7d23f7c699df01"
        };

        let state = {
            id: "", status: "SETUP", p1: "P1", p2: "P2", loc: "Court", fmt: "pro-ad",
            srv: 1, set: 0, setsWon: [0,0], games: [[0,0],[0,0],[0,0]], score: [0,0],
            history: [], start: null, end: null, tie: false
        };

        // --- LOGGING ---
        function writeLog(msg) {
            const logBox = document.getElementById('debug-log');
            const entry = document.createElement('div');
            entry.textContent = `> ${msg}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        // --- SCORING ENGINE ---
        function calculatePoint(winner) {
            const idx = winner - 1;
            const opp = idx === 0 ? 1 : 0;
            const isAd = state.fmt.endsWith('ad');

            if (state.tie) {
                state.score[idx]++;
                if (state.score[idx] >= 7 && (state.score[idx] - state.score[opp] >= 2)) triggerGameWin(winner);
            } else if (isAd) {
                // STRICT TENNIS AD LOGIC (FIXED)
                if (state.score[idx] === 3 && state.score[opp] < 3) triggerGameWin(winner); // Wins at 40-0, 40-15, 40-30
                else if (state.score[idx] === 3 && state.score[opp] === 3) state.score[idx] = 4; // Deuce -> Ad In
                else if (state.score[idx] === 4) triggerGameWin(winner); // Ad -> Game
                else if (state.score[opp] === 4) state.score[opp] = 3; // Opp Ad -> Deuce
                else state.score[idx]++;
            } else {
                if (state.score[idx] === 3) triggerGameWin(winner);
                else state.score[idx]++;
            }
        }

        function triggerGameWin(winner) {
            const s = state.set;
            state.games[s][winner-1]++;
            state.score = [0,0];
            state.tie = false;
            state.srv = state.srv === 1 ? 2 : 1;

            const targetG = state.fmt.startsWith('pro') ? 8 : 6;
            const g1 = state.games[s][0];
            const g2 = state.games[s][1];

            if ((g1 >= targetG || g2 >= targetG) && Math.abs(g1 - g2) >= 2) {
                state.setsWon[winner-1]++;
                const targetS = state.fmt.startsWith('pro') ? 1 : 2;
                if (state.setsWon[winner-1] === targetS) {
                    state.status = "ENDED"; state.end = Date.now();
                } else state.set++;
            } else if (g1 === targetG && g2 === targetG) state.tie = true;
        }

        // --- CLOUD SYNC ---
        async function syncToCloud() {
            if (!state.id || !db) return;
            const path = `artifacts/${appId}/public/data/matches`;
            const payload = JSON.parse(JSON.stringify(state));
            payload.games = JSON.stringify(payload.games);
            try {
                await db.collection(path).doc(state.id).set(payload);
                writeLog("Cloud storage synced.");
            } catch (e) {
                writeLog("Cloud Sync Error: " + e.message);
                writeLog("NOTE: Running in LOCAL-ONLY mode for now.");
            }
        }

        function renderInterface() {
            const setup = state.status === "SETUP";
            const isSpec = new URLSearchParams(window.location.search).get('mode') === 'spectate';

            document.getElementById('setup-modal').style.display = (setup && !isSpec) ? 'flex' : 'none';
            document.getElementById('scoreboard-area').classList.toggle('hidden', setup);
            document.getElementById('scoring-controls').classList.toggle('hidden', setup || isSpec);
            document.getElementById('btn-share').classList.toggle('hidden', setup || isSpec);

            document.getElementById('ui-p1-name').textContent = state.p1;
            document.getElementById('ui-p2-name').textContent = state.p2;
            document.getElementById('btn-p1-label').textContent = state.p1;
            document.getElementById('btn-p2-label').textContent = state.p2;
            document.getElementById('ui-p1-srv').textContent = state.srv === 1 ? 'ðŸŽ¾' : '';
            document.getElementById('ui-p2-srv').textContent = state.srv === 2 ? 'ðŸŽ¾' : '';

            const isPro = state.fmt.startsWith('pro');
            document.getElementById('ui-p1-s2').style.opacity = isPro ? '0' : '1';
            document.getElementById('ui-p1-s3').style.opacity = isPro ? '0' : '1';
            document.getElementById('ui-p2-s2').style.opacity = isPro ? '0' : '1';
            document.getElementById('ui-p2-s3').style.opacity = isPro ? '0' : '1';

            for(let i=0; i<3; i++) {
                document.getElementById(`ui-p1-s${i+1}`).textContent = state.games[i][0];
                document.getElementById(`ui-p2-s${i+1}`).textContent = state.games[i][1];
            }

            const getPts = (p, o) => state.tie ? p : (p === 3 && o === 3 ? 'Deuce' : ptsMap[p]);
            document.getElementById('ui-p1-game').textContent = getPts(state.score[0], state.score[1]);
            document.getElementById('ui-p2-game').textContent = getPts(state.score[1], state.score[0]);

            document.getElementById('meta-id').textContent = `Match: ${state.id}`;
            document.getElementById('meta-loc').textContent = `Loc: ${state.loc}`;

            if(state.start && state.status === "PLAYING" && !liveDurationInterval) {
                liveDurationInterval = setInterval(() => {
                    const elapsed = Date.now() - state.start;
                    document.getElementById('timer-display').textContent = new Date(elapsed).toISOString().substr(11, 8);
                }, 1000);
            }
        }

        // --- BUTTON ACTIONS ---
        window.startTheMatch = async function() {
            writeLog("Starting match sequence...");
            const p1 = document.getElementById('p1-input').value.trim() || "Player 1";
            const p2 = document.getElementById('p2-input').value.trim() || "Player 2";
            const loc = document.getElementById('loc-input').value.trim() || "Court";
            const fmt = document.querySelector('input[name="fmt"]:checked').value;
            const srv = parseInt(document.querySelector('input[name="srv"]:checked').value);

            const uidPart = auth.currentUser ? auth.currentUser.uid.substr(0,4) : 'local';
            
            state = {
                id: uidPart + '-' + Math.floor(Math.random()*9000),
                status: "PLAYING", p1, p2, loc, fmt, srv,
                set: 0, setsWon: [0,0], games: [[0,0],[0,0],[0,0]], score: [0,0],
                history: [], start: Date.now(), end: null, tie: false
            };

            writeLog("Transitioning UI...");
            renderInterface(); // TRANSITION IMMEDIATELY
            
            writeLog("Attempting background cloud save...");
            syncToCloud(); // SAVE IN BACKGROUND
        };

        window.submitPoint = function(winner) {
            calculatePoint(winner);
            renderInterface();
            syncToCloud();
        };

        window.copyLink = () => {
            const url = `${window.location.origin}${window.location.pathname}?matchId=${state.id}&mode=spectate`;
            const el = document.createElement('textarea'); el.value = url; document.body.appendChild(el);
            el.select(); document.execCommand('copy'); document.body.removeChild(el);
            alert("Spectator link copied!");
        };

        // --- INITIALIZATION ---
        window.onload = async () => {
            writeLog("App Loading...");
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();

            auth.onAuthStateChanged(async (user) => {
                if(!user) {
                    writeLog("Requesting authentication...");
                    await auth.signInAnonymously();
                    return;
                }
                writeLog("Auth verified: " + user.uid);
                document.getElementById('db-indicator').classList.replace('bg-red-500', 'bg-green-500');

                const mid = new URLSearchParams(window.location.search).get('matchId');
                if(mid) {
                    writeLog("Retrieving Cloud data for ID: " + mid);
                    db.collection(`artifacts/${appId}/public/data/matches`).doc(mid).onSnapshot(doc => {
                        if(doc.exists) {
                            const d = doc.data();
                            d.games = JSON.parse(d.games);
                            state = d; renderInterface();
                        }
                    }, err => writeLog("Snapshot Error: " + err.message));
                } else {
                    renderInterface();
                }
            });
        };
    </script>
</body>
</html>